#include "instruction_set.h"
#include "basic_core.h"

uint8_t mem[MEM_SIZE];

core_state basic_core;

int main() {
    // init
    basic_core.ip = 0x0;
    basic_core.ir = 0x0;
    basic_core.lr = 0x0;
    basic_core.sp = 0x0;
    basic_core.msr = 0x0;
    basic_core.pidr = 0x0;
    
    for (int i = 0; i < GPR_FILE_SIZE; i++) {
        basic_core.gpr_file[i] = 0x0;
    }

//    // 1: ld.h r1, r2, 0x84
//    mem[0x0] = 0x08; 
//    mem[0x1] = 0x12;
//    mem[0x2] = 0x20;
//    mem[0x3] = 0x84; 
//    // 2: ld.h r2, r1, r3
//    mem[0x4] = 0x00; 
//    mem[0x5] = 0x22;
//    mem[0x6] = 0x10;
//    mem[0x7] = 0x30; 
//    // 3: add.h r3, r1, 0d2
//    mem[0x8] = 0x28; 
//    mem[0x9] = 0x32;
//    mem[0xa] = 0x10;
//    mem[0xb] = 0x02; 
//    // 4: ld.h r4, r3, 0d0
//    mem[0xc] = 0x08; 
//    mem[0xd] = 0x42;
//    mem[0xe] = 0x30;
//    mem[0xf] = 0x00; 
//    // 5: add.h r5, r0, r2 
//    mem[0x10] = 0x20; 
//    mem[0x11] = 0x52;
//    mem[0x12] = 0x00;
//    mem[0x13] = 0x20; 
//    // 6: add.h r6, r0, 0d1
//    mem[0x14] = 0x28; 
//    mem[0x15] = 0x62;
//    mem[0x16] = 0x00;
//    mem[0x17] = 0x01; 
//    // 6: add.h r7, r0, 0d3
//    mem[0x18] = 0x28; 
//    mem[0x19] = 0x72;
//    mem[0x1a] = 0x00;
//    mem[0x1b] = 0x03; 
//    // 7: and.h r7, r0, 0d3
//    mem[0x18] = 0x28; 
//    mem[0x19] = 0x72;
//    mem[0x1a] = 0x00;
//    mem[0x1b] = 0x03; 
//    // 8: add.h r7, r0, 0d3
//    mem[0x18] = 0x28; 
//    mem[0x19] = 0x72;
//    mem[0x1a] = 0x00;
//    mem[0x1b] = 0x03; 
//    // data
//    mem[0x84] = 0x00;
//    mem[0x85] = 0x86;
//    mem[0x86] = 0xBE;
//    mem[0x87] = 0xEF;
//    mem[0x88] = 0xDE;
//    mem[0x89] = 0xAD;

//    mem[0x0100] = 0xff;
//    mem[0x0101] = 0xfe;
//    mem[0x0000] = 0x08;
//    mem[0x0001] = 0x12;
//    mem[0x0002] = 0x00;
//    mem[0x0003] = 0xfc;
//    mem[0x0004] = 0x28;
//    mem[0x0005] = 0x32;
//    mem[0x0006] = 0x10;
//    mem[0x0007] = 0x01;

// b unconditional test
//    mem[0x0100] = 0xff;
//    mem[0x0101] = 0xfe;
//    mem[0x0000] = 0x08;
//    mem[0x0001] = 0x12;
//    mem[0x0002] = 0x00;
//    mem[0x0003] = 0xfc;
//    mem[0x0004] = 0x82;
//    mem[0x0005] = 0x00;
//    mem[0x0006] = 0x00;
//    mem[0x0007] = 0x04;
//    mem[0x0008] = 0x28;
//    mem[0x0009] = 0x32;
//    mem[0x000a] = 0x10;
//    mem[0x000b] = 0x01;
//    mem[0x000c] = 0x28;
//    mem[0x000d] = 0x32;
//    mem[0x000e] = 0x00;
//    mem[0x000f] = 0x01;

// ld set condition test
//    mem[0x0100] = 0xff;
//    mem[0x0101] = 0xfe;
//    mem[0x0000] = 0x0a;
//    mem[0x0001] = 0x12;
//    mem[0x0002] = 0x00;
//    mem[0x0003] = 0xfc;
//    mem[0x0004] = 0x82;
//    mem[0x0005] = 0x00;
//    mem[0x0006] = 0x00;
//    mem[0x0007] = 0x04;
//    mem[0x0008] = 0x28;
//    mem[0x0009] = 0x32;
//    mem[0x000a] = 0x10;
//    mem[0x000b] = 0x01;
//    mem[0x000c] = 0x28;
//    mem[0x000d] = 0x32;
//    mem[0x000e] = 0x00;
//    mem[0x000f] = 0x01;

// b.lt test
//    mem[0x0100] = 0xff;
//    mem[0x0101] = 0xfe;
//    mem[0x0000] = 0x0a;
//    mem[0x0001] = 0x12;
//    mem[0x0002] = 0x00;
//    mem[0x0003] = 0xfc;
//    mem[0x0004] = 0x80;
//    mem[0x0005] = 0x00;
//    mem[0x0006] = 0x40;
//    mem[0x0007] = 0x04;
//    mem[0x0008] = 0x28;
//    mem[0x0009] = 0x32;
//    mem[0x000a] = 0x10;
//    mem[0x000b] = 0x01;
//    mem[0x000c] = 0x28;
//    mem[0x000d] = 0x32;
//    mem[0x000e] = 0x00;
//    mem[0x000f] = 0x01;
//    mem[0x0010] = 0x82;
//    mem[0x0011] = 0x00;
//    mem[0x0012] = 0x0f;
//    mem[0x0013] = 0xfc; 

// b.gt test
//    mem[0x0100] = 0xff;
//    mem[0x0101] = 0xfe;
//    mem[0x0000] = 0x0a;
//    mem[0x0001] = 0x12;
//    mem[0x0002] = 0x00;
//    mem[0x0003] = 0xfc;
//    mem[0x0004] = 0x80;
//    mem[0x0005] = 0x00;
//    mem[0x0006] = 0x30;
//    mem[0x0007] = 0x08;
//    mem[0x0008] = 0x28;
//    mem[0x0009] = 0x32;
//    mem[0x000a] = 0x10;
//    mem[0x000b] = 0x01;
//    mem[0x000c] = 0x82;
//    mem[0x000d] = 0x00;
//    mem[0x000e] = 0x00;
//    mem[0x000f] = 0x04;
//    mem[0x0010] = 0x28;
//    mem[0x0011] = 0x32;
//    mem[0x0012] = 0x00;
//    mem[0x0013] = 0x01;
//    mem[0x0014] = 0x82;
//    mem[0x0015] = 0x00;
//    mem[0x0016] = 0x0f;
//    mem[0x0017] = 0xfc;

// add set condition flags
    mem[0x0100] = 0xff;
    mem[0x0101] = 0xfe;
    mem[0x0000] = 0x0a;
    mem[0x0001] = 0x12;
    mem[0x0002] = 0x00;
    mem[0x0003] = 0xfc;
    mem[0x0004] = 0x80;
    mem[0x0005] = 0x00;
    mem[0x0006] = 0x30;
    mem[0x0007] = 0x08;
    mem[0x0008] = 0x2a;
    mem[0x0009] = 0x32;
    mem[0x000a] = 0x10;
    mem[0x000b] = 0x01;

    mem[0x000c] = 0x80;
    mem[0x000d] = 0x00;
    mem[0x000e] = 0x30;
    mem[0x000f] = 0x04;

    mem[0x0010] = 0x28;
    mem[0x0011] = 0x42;
    mem[0x0012] = 0x00;
    mem[0x0013] = 0x01;

    mem[0x0014] = 0x82;
    mem[0x0015] = 0x00;
    mem[0x0016] = 0x0f;
    mem[0x0017] = 0xfc;

    printf("Initial state:\n");
    for (int i = 0; i < GPR_FILE_SIZE; i++) {
        printf("GPR %i: 0x%08X\n", i, basic_core.gpr_file[i]);
    }
    printf("-----\n");

    // run core
    int num_steps = 7;
    int i = 0;
    while (i < num_steps) {
        basic_core.ir = core_fetch(&basic_core.ip, mem);
        core_decode_execute_complete(&basic_core, mem); 

        printf("Step %d:\n", i + 1);
        printf("IR: 0x%08X\n", basic_core.ir);
        printf("IP: 0x%08X\n", basic_core.ip);
        printf("LR: 0x%08X\n", basic_core.lr);
        printf("MSR: 0x%08X\n", basic_core.msr);
        for (int i = 0; i < GPR_FILE_SIZE; i++) {
            printf("GPR %i: 0x%08X\n", i, basic_core.gpr_file[i]);
        }
        printf("-----\n");

        i++;
    }    
    return 0;
}

